<!DOCTYPE HTML>
<html>

<head>
   <title>Index</title>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
   
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>

   <div id="createUpdateDept" style="display:none">
      <h2 id="titleCreateDept" class="h2">Create Department</h2>
      <h2 id="titleUpdateDept" class="h2">Update Department</h2>
      <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
      <button onclick="showDeptDisplay()" type="button" class="btn btn-success">All Departments</button>
      <table id="createUpdateDeptForm" class="table">
         <thead class="thead-dark">
            <tr>
               <th scope="col">Details</th>
               <th scope="col">Department Input</th>
            </tr>
         </thead>
         <tr>
            <th scope="col">DeptID</th>
            <td><input type="text" class="form-control" name="deptID" placeholder="not available" readonly="readonly"></td>
         </tr>
         <tr>
            <th scope="col">Name</th>
            <td><input type="text" class="form-control" name="name" placeholder="enter name" required></td>
         </tr>
         <tr>
            <th scope="col">Location</th>
            <td><input type="text" class="form-control" name="location" placeholder="enter location" required></td>
         </tr>
         <tr>
            <th scope="col">Budget</th>
            <td><input type="number" class="form-control" name="budget" placeholder="enter budget in euro" required></td>
         </tr>
         <tr>
            <td></td>
            <td>
               <button id="createDept" onclick="doCreateDept()" type="button" class="btn btn-success">Create</button>
               <button id="updateDept" onclick="doUpdateDept()"type="button" class="btn btn-info">Update</button>
            </td>
         </tr>
      </table>
   </div>

   <div id="createUpdateEmp" style="display:none">
      <h2 id="titleCreateEmp" class="h2">Create Employee</h2>
      <h2 id="titleUpdateEmp" class="h2">Update Employee</h2>
      <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
      <button onclick="showEmpDisplay()" type="button" class="btn btn-success">All Employees</button>
      <table id="createUpdateEmpForm" class="table">
         <thead class="thead-dark">
            <tr>
               <th scope="col">Details</th>
               <th scope="col">Employee Input</th>
            </tr>
         </thead>
         <tr>
            <th scope="col">EmpID</th>
            <td><input type="text" class="form-control" name="empID" placeholder="not available" readonly="readonly"></td>
         </tr>
         <tr>
            <th scope="col">Name</th>
            <td><input type="text" class="form-control" name="name" placeholder="enter name" required></td>
         </tr>
         <tr>
            <th scope="col">Address</th>
            <td><input type="text" class="form-control" name="address" placeholder="enter address" required></td>
         </tr>
         <tr>
            <th scope="col">Salary</th>
            <td><input type="number" class="form-control" name="salary" placeholder="enter salary in euro" required></td>
         </tr>
         <tr>
            <th scope="col">Dept</th>
            <td><input type="number" class="form-control" name="dept" placeholder="enter department ID number" required></td>
         </tr>
         <tr>
            <td></td>
            <td>
               <button id="createEmp" onclick="doCreateEmp()" type="button" class="btn btn-success">Create</button>
               <button id="updateEmp" onclick="doUpdateEmp()" type="button" class="btn btn-info">Update</button>
            </td>
         </tr>
      </table>
   </div>

   <div id="displayDept" style="display:none">
      <h2 class="h2">Departments</h2>
      <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
      <button onclick="showDeptCreate()" type="button" class="btn btn-success">Create Department</button>
      <table id="deptTable" class="table">
         <thead class="thead-dark">
            <tr>
               <th scope="col">DeptID</th>
               <th scope="col">Name</th>
               <th scope="col">Location</th>
               <th scope="col">Budget</th>
               <th scope="col" colspan="2">Options</th>
            </tr>
         </thead>
      </table>
   </div>

   <div id="displayEmp" style="display:none">
      <h2 class="h2">Employees</h2>
      <button onclick="showHome()" type="button" class="btn btn-primary">Home</button>
      <button onclick="showEmpCreate()" type="button" class="btn btn-success">Create Employee</button>
      <table id="empTable" class="table">
         <thead class="thead-dark">
            <tr>
               <th scope="col">EmpID</th>
               <th scope="col">Name</th>
               <th scope="col">Address</th>
               <th scope="col">Salary</th>
               <th scope="col">Dept</th>
               <th scope="col" colspan="2">Options</th>
            </tr>
         </thead>
      </table>
   </div>

   <div id="displayHome">
      <h2 class="h2">Home Page</h2>
      <table id="HomeTable" class="table">
         <tr>
            <td>
               <button onclick="showDeptDisplay()" type="button" class="btn btn-success">All Departments</button>
            </td>
         </tr>
         <tr>
            <td>
               <button onclick="showEmpDisplay()" type="button" class="btn btn-success">All Employees</button>
            </td>
         </tr>
      </table>
   </div>

   <script>

      function showDeptDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "block"
         document.getElementById('displayEmp').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdateEmp').style.display = "none"
      }

      function showDeptCreate(){
         clearDeptForm()
         
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displayEmp').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "block"
         document.getElementById('createUpdateEmp').style.display = "none"
         // title
         document.getElementById('titleCreateDept').style.display = "block"
         document.getElementById('titleUpdateDept').style.display = "none"
         // buttons
         document.getElementById('createDept').style.display = "block"
         document.getElementById('updateDept').style.display = "none"
      }

      function showDeptUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         dept = readDeptFromRow(rowElement)
         populateDeptForm(dept)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displayEmp').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "block"
         document.getElementById('createUpdateEmp').style.display = "none"
         // title
         document.getElementById('titleCreateDept').style.display = "none"
         document.getElementById('titleUpdateDept').style.display = "block"
         // buttons
         document.getElementById('createDept').style.display = "none"
         document.getElementById('updateDept').style.display = "block"
      }

      function readDeptFromRow(rowElement) {
         dept = {}
         // deptID is dept table row id omitting the first character 'd'
         dept.deptID = rowElement.getAttribute("id").substr(1);
         dept.name = rowElement.cells[1].firstChild.textContent
         dept.location = rowElement.cells[2].firstChild.textContent
         dept.budget = rowElement.cells[3].firstChild.textContent
         return dept
      }
      function populateDeptForm(dept) {
         var form = document.getElementById('createUpdateDeptForm')

         form.querySelector('input[name="deptID"]').value = dept.deptID
         form.querySelector('input[name="deptID"]').disabled = true

         form.querySelector('input[name="name"]').value = dept.name
         form.querySelector('input[name="location"]').value = dept.location
         form.querySelector('input[name="budget"]').value = dept.budget
      }
      function clearDeptForm() {
         var form = document.getElementById('createUpdateDeptForm')

         form.querySelector('input[name="deptID"]').value = ''
         form.querySelector('input[name="deptID"]').disabled = true

         form.querySelector('input[name="name"]').value = ''
         form.querySelector('input[name="location"]').value = ''
         form.querySelector('input[name="budget"]').value = ''
      }

      function doUpdateDept() {
         dept = getDeptFromForm()
         if (validateDeptForm(dept) == 1) {
            updateDeptServer(dept)         
         }
      }

      function updateDeptServer(dept) {
         // ajax updateDept
         host = window.location.origin
         $.ajax({
            url: host + "/departments/" + dept.deptID,
            data: JSON.stringify(dept),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updateDeptTableRow(dept)
               showDeptDisplay()
               clearDeptForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
            }
         })
      }

      function updateDeptTableRow(dept) {
         rowElement = document.getElementById("d" + dept.deptID)
         rowElement.cells[1].firstChild.textContent = dept.name
         rowElement.cells[2].firstChild.textContent = dept.location
         rowElement.cells[3].firstChild.textContent = dept.budget
         //console.log("updating dept table")
      }

      function doCreateDept() {
         dept = getDeptFromForm()
         if (validateDeptForm(dept) == 1) {
            // ajax createDept
            host = window.location.origin
            $.ajax({
               url: host + '/departments',
               data: JSON.stringify(dept),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Department " + result + " added")
                  dept.deptID = result
                  addDepttoTable(dept)
                  showDeptDisplay()
                  clearDeptForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
               }
            })
         }

      }

      function doDeptDelete(thisElem){
         var tableElement = document.getElementById('deptTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         // deptID is dept table row id omitting the first character 'd'
         var dept = rowElement.getAttribute("id").substr(1);
         // ajax deleteDept
         host = window.location.origin
         $.ajax({
            url: host + "/departments/"+dept,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               tableElement.deleteRow(index);
               console.log("Department " + dept + " deleted")
            },
            error:function(xhr,status,error){
               console.log(error)
               alert("Cannot delete department with associated employees")
            }
         })
      }

      function showEmpDisplay() {
         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displayEmp').style.display = "block"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdateEmp').style.display = "none"
      }

      function showEmpCreate() {
         clearEmpForm()

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displayEmp').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdateEmp').style.display = "block"
         // title
         document.getElementById('titleCreateEmp').style.display = "block"
         document.getElementById('titleUpdateEmp').style.display = "none"
         // buttons
         document.getElementById('createEmp').style.display = "block"
         document.getElementById('updateEmp').style.display = "none"
      }

      function showEmpUpdate(thisElem) {
         var rowElement = thisElem.parentNode.parentNode;
         emp = readEmpFromRow(rowElement)
         populateEmpForm(emp)

         document.getElementById('displayHome').style.display = "none"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displayEmp').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdateEmp').style.display = "block"
         // title
         document.getElementById('titleCreateEmp').style.display = "none"
         document.getElementById('titleUpdateEmp').style.display = "block"
         // buttons
         document.getElementById('createEmp').style.display = "none"
         document.getElementById('updateEmp').style.display = "block"
      }

      function readEmpFromRow(rowElement) {
         emp = {}
         // empID is emp table row id omitting the first character 'e'
         emp.empID = rowElement.getAttribute("id").substr(1);
         emp.name = rowElement.cells[1].firstChild.textContent
         emp.address = rowElement.cells[2].firstChild.textContent
         emp.salary = rowElement.cells[3].firstChild.textContent
         emp.dept = rowElement.cells[4].firstChild.textContent
         // console.log(emp.empID)
         return emp
      }

      function populateEmpForm(emp) {
         var form = document.getElementById('createUpdateEmpForm')

         form.querySelector('input[name="empID"]').value = emp.empID
         form.querySelector('input[name="empID"]').disabled = true

         form.querySelector('input[name="name"]').value = emp.name
         form.querySelector('input[name="address"]').value = emp.address
         form.querySelector('input[name="salary"]').value = emp.salary
         form.querySelector('input[name="dept"]').value = emp.dept
      }
      function clearEmpForm() {
         var form = document.getElementById('createUpdateEmpForm')

         form.querySelector('input[name="empID"]').value = ''
         form.querySelector('input[name="empID"]').disabled = true

         form.querySelector('input[name="name"]').value = ''
         form.querySelector('input[name="address"]').value = ''
         form.querySelector('input[name="salary"]').value = ''
         form.querySelector('input[name="dept"]').value = ''
      }

      function doUpdateEmp() {
         emp = getEmpFromForm()
         // console.log(emp)
         if (validateEmpForm(emp) == 1) {
            updateEmpServer(emp)       
         }
      }

      function updateEmpServer(emp) {
         // ajax updateEmp
         host = window.location.origin
         $.ajax({
            url: host + "/employees/" + emp.empID,
            data: JSON.stringify(emp),
            method: "PUT",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (result) {
               console.log(result)
               updateEmpTableRow(emp)
               showEmpDisplay()
               clearEmpForm()
            },
            error: function (xhr, status, error) {
               console.log("error" + error)
               // NOTE: deptID has to exist to assign an employee to a deptID
               alert("INPUT ERROR: Department ID not found")
            }
         })
      }

      function updateEmpTableRow(emp) {
         rowElement = document.getElementById("e" + emp.empID)
         rowElement.cells[1].firstChild.textContent = emp.name
         rowElement.cells[2].firstChild.textContent = emp.address
         rowElement.cells[3].firstChild.textContent = emp.salary
         rowElement.cells[4].firstChild.textContent = emp.dept
         // console.log("updating emp table")
      }

      function doCreateEmp() {
         emp = getEmpFromForm()
         if (validateEmpForm(emp) == 1) {
            // ajax createEmp
            host = window.location.origin
            $.ajax({
               url: host + '/employees',
               data: JSON.stringify(emp),
               method: 'POST',
               datatype: 'JSON',
               contentType: "application/json; charset=utf-8",
               success: function (result) {
                  console.log("Employee " + result + " created")
                  emp.empID = result
                  addEmptoTable(emp)
                  showEmpDisplay()
                  clearEmpForm()
               },
               error: function (xhr, status, error) {
                  console.log("error " + error)
                  // NOTE: deptID has to exist to assign an employee to a deptID
                  alert("INPUT ERROR: Department ID not found")
               }
            })
         }
      }

      function doEmpDelete(thisElem){
         var tableElement = document.getElementById('empTable');
         var rowElement = thisElem.parentNode.parentNode;
         var index = rowElement.rowIndex;
         // empID is emp table row id omitting the first character 'e'
         emp = rowElement.getAttribute("id").substr(1);
         // ajax deleteEmp
         host = window.location.origin
         $.ajax({
            url: host + "/employees/"+ emp,
            method:"DELETE",
            dateType:"JSON",
            success:function(result){
               tableElement.deleteRow(index);
               console.log("Employee " + emp + " deleted")
            },
            error:function(xhr,status,error){
               console.log(error)
            }
         })
      }

      function showHome() {
         document.getElementById('displayHome').style.display = "block"
         document.getElementById('displayDept').style.display = "none"
         document.getElementById('displayEmp').style.display = "none"
         document.getElementById('createUpdateDept').style.display = "none"
         document.getElementById('createUpdateEmp').style.display = "none"
      }

      function getDeptFromForm(){
         var form = document.getElementById('createUpdateDeptForm')
         var dept = {}
         dept.deptID = parseInt(form.querySelector('input[name="deptID"]').value)
         dept.name = form.querySelector('input[name="name"]').value
         dept.location = form.querySelector('input[name="location"]').value
         dept.budget = parseInt(form.querySelector('input[name="budget"]').value)
         // console.log(dept)
         return dept
      }

      function validateDeptForm(d){
         // Check if and department form fields are are empty. Code adapted from
         // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isNaN
         if (d.name.length == 0 || d.location.length == 0 || Number.isNaN(d.budget) == true ){
            alert("INPUT ERROR: Blank department form field entered")
            return 0
         }
         return 1
      }

      function getEmpFromForm(){
         var form = document.getElementById('createUpdateEmpForm')
         var emp = {}
         emp.empID = parseInt(form.querySelector('input[name="empID"]').value)
         emp.name = form.querySelector('input[name="name"]').value
         emp.address = form.querySelector('input[name="address"]').value
         emp.salary = parseInt(form.querySelector('input[name="salary"]').value)
         emp.dept = parseInt(form.querySelector('input[name="dept"]').value)
         // console.log(emp)
         return emp
      }

      function validateEmpForm(e){
         // Check if any employee form fields are empty
         if (e.name.length == 0 || e.address.length == 0 || Number.isNaN(e.salary) == true || Number.isNaN(e.dept) == true){
            alert("INPUT ERROR: Blank employee form field entered")
            return 0
         }
         return 1
      }

      function populateDeptTable(){
         // ajax getAllDept
         host = window.location.origin
         $.ajax({
            url: host + '/departments',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (dept of results) {
                  addDepttoTable(dept)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function populateEmpTable(){
         // ajax getAllEmp
         host = window.location.origin
         $.ajax({
            url: host + '/employees',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               for (emp of results) {
                  addEmptoTable(emp)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

      function addDepttoTable(dept){
         // console.log("add to dept table working")
         var tableElem = document.getElementById('deptTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "d"+dept.deptID)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = dept.deptID
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = dept.name
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = dept.location
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = dept.budget
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = '<button onclick="showDeptUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell6 = rowElem.insertCell(5);
         cell6.innerHTML = '<button onclick="doDeptDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      function addEmptoTable(emp){
         // console.log("add to emp table working")
         var tableElem = document.getElementById('empTable')
         var rowElem = tableElem.insertRow(-1)
         rowElem.setAttribute('id', "e"+emp.empID)
         var cell1 = rowElem.insertCell(0);
         cell1.innerHTML = emp.empID
         var cell2 = rowElem.insertCell(1);
         cell2.innerHTML = emp.name
         var cell3 = rowElem.insertCell(2);
         cell3.innerHTML = emp.address
         var cell4 = rowElem.insertCell(3);
         cell4.innerHTML = emp.salary
         var cell5 = rowElem.insertCell(4);
         cell5.innerHTML = emp.dept
         var cell6 = rowElem.insertCell(5);
         cell6.innerHTML = '<button onclick="showEmpUpdate(this)"  type="button" class="btn btn-info">Update</button>'
         var cell7 = rowElem.insertCell(6);
         cell7.innerHTML = '<button onclick="doEmpDelete(this)" type="button" class="btn btn-danger">Delete</button>'
      }

      populateDeptTable()
      populateEmpTable()
   </script>
</body>

</html>