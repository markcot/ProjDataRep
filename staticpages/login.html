<!doctype html>
<html lang="en">

<head>
   <title>Login</title>
   <meta charset="UTF-8">
   <meta name="description" content="enter login details">
   <meta name="keywords" content="Galway, ICT, Department, Employee, Records">
   <meta name="author" content="Mark Cotter">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body class="p-3 mb-2 bg-secondary text-white">
   <!-- Webpage Company Title -->
   <div style="width:270px; margin:0 auto;">
      <h1 class="h1"><img src="https://thisisgalway.ie/wp-content/uploads/2018/10/Green-Bites-Green-Galway.png" width=270><br />
      Galway ICT Ltd</h1>
   </div>

   <hr>

   <div id="login-form" style="width:700px; margin:0 auto;">
   <!-- Login Screen Form with required fields to be entered
		 Code adapted from https://www.w3schools.com/tags/att_form_action.asp
		 & https://www.w3schools.com/tags/att_input_required.asp
       & https://css-tricks.com/a-complete-guide-to-links-and-buttons/ &
       https://getbootstrap.com/docs/4.3/components/forms/? -->
      <form id="login">
         <div class="form-group">
            <legend class="form-label">User Login</legend>
         </div>
         <div class="form-group row">
            <label for="uname" class="col-sm-2 col-form-label">User:</label>
            <div class="col-sm-10">
               <input id="cuname" type="text" name="uname" class="form-control" placeholder="enter user name" required>
            </div>
         </div>
         <div class="form-group row">
            <label for="pword" class="col-sm-2 col-form-label">Password:</label>
            <div class="col-sm-10">
               <!-- type="password" not used here to avoid Chrome password warning -->
               <input id="cpword" type="text" name="pword" class="form-control" placeholder="enter password" required>
            </div>
         </div>
         <div class="form-group">
            <input id="login-button" type="button" class="btn btn-primary" value="Login" onclick="validateDetails()">
         </div>
      </form>
   </div>
   <div id="logged-in" style="width:700px; margin:0 auto; display:none;">
      <h2 id="logged-in-heading" class="h2"></h2>
      <a href="#" id="home-page-link">
         <input id="index-button" type="button" class="btn btn-primary" value="Home" >
      </a>
   </div>

   <hr>

   <script>
      
      var loggedIn = false;
      
      // Changes display after login
      function showLoggedIn() {
         document.getElementById('login-form').style.display = "none"
         document.getElementById('logged-in').style.display = "block"
      }

      // Validate and check user details
      function validateDetails() {

         // Get details from form
         // var loginForm = document.getElementById("login");
         var uname = document.getElementById("cuname").value;
         var pword = document.getElementById("cpword").value;

         // ajax getAllUser
         host = window.location.origin
         $.ajax({
            url: host + '/u',
            method: 'GET',
            datatype: 'JSON',
            success: function (results) {
               // console.log(results);
               // Set variable for checking submit, user and password are acceptable
               var submitOK = "false";
               var unameOK = "false";
               var unameDB = "";
               var pwordDB = "";

               for (u of results) {
                  // console.log(u.name);
                  if (uname.toLowerCase() == u.name.toLowerCase()) {
                     unameDB = u.name;
                     pwordDB = u.password;
                     unameOK = "true";
                     // console.log("Name is true");
                     // console.log("DB password is " + pwordDB);
                     // console.log("Form password is " + pword);
                  }
               }

               // Check user name entered into form
               if (uname == "") {
                  alert("User cannot be empty");
                  submitOK = "false";
               } else if (unameOK == "false") {
                  alert("User " + uname + " not found");
                  submitOK = "false";

                  // Check password entered into form for user
               } else if (pword == "") {
                  alert("Password cannot be empty");
                  submitOK = "false";
               } else if (pword != pwordDB) {
                  alert("Password incorrect for user " + unameDB);
                  submitOK = "false";

               // All checked user details are ok
               } else {
                  submitOK = "true";
               }

               // Check if submitted user detail are acceptable.
               if (submitOK == "true") {
                  // Use login form to provide a link to the index page.
                  document.getElementById('logged-in-heading').innerHTML = "Logged in as: " + uname;
                  document.getElementById('home-page-link').href = host + "/index.html";
                  showLoggedIn()
                  // Clear the form fields
                  document.getElementById("cuname").value = "";
                  document.getElementById("cpword").value = "";
                  console.log("Logged in as: " + uname)
               }
            },
            error: function (xhr, status, error) {
               console.log("error " + error + " code:" + status)
            }
         })
      }

   </script>

</body>

</html>

